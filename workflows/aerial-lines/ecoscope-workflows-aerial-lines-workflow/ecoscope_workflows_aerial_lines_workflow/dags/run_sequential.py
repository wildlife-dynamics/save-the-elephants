# AUTOGENERATED BY ECOSCOPE-WORKFLOWS; see fingerprint in README.md for details
import json
import os

from ecoscope_workflows_core.tasks.analysis import (
    apply_arithmetic_operation as apply_arithmetic_operation,
)
from ecoscope_workflows_core.tasks.config import (
    set_workflow_details as set_workflow_details,
)
from ecoscope_workflows_core.tasks.filter import set_time_range as set_time_range
from ecoscope_workflows_core.tasks.groupby import set_groupers as set_groupers
from ecoscope_workflows_core.tasks.results import (
    create_single_value_widget_single_view as create_single_value_widget_single_view,
)
from ecoscope_workflows_core.tasks.results import gather_dashboard as gather_dashboard
from ecoscope_workflows_ext_ste.tasks import add_two_thousand as add_two_thousand

from ..params import Params


def main(params: Params):
    params_dict = json.loads(params.model_dump_json(exclude_unset=True))

    workflow_details = (
        set_workflow_details.validate()
        .set_task_instance_id("workflow_details")
        .handle_errors()
        .with_tracing()
        .partial(**(params_dict.get("workflow_details") or {}))
        .call()
    )

    time_range = (
        set_time_range.validate()
        .set_task_instance_id("time_range")
        .handle_errors()
        .with_tracing()
        .partial(
            time_format="%d %b %Y %H:%M:%S %Z", **(params_dict.get("time_range") or {})
        )
        .call()
    )

    groupers = (
        set_groupers.validate()
        .set_task_instance_id("groupers")
        .handle_errors()
        .with_tracing()
        .partial(**(params_dict.get("groupers") or {}))
        .call()
    )

    calculator = (
        apply_arithmetic_operation.validate()
        .set_task_instance_id("calculator")
        .handle_errors()
        .with_tracing()
        .partial(**(params_dict.get("calculator") or {}))
        .call()
    )

    add_more = (
        add_two_thousand.validate()
        .set_task_instance_id("add_more")
        .handle_errors()
        .with_tracing()
        .partial(value=calculator, **(params_dict.get("add_more") or {}))
        .call()
    )

    sv_widgets = (
        create_single_value_widget_single_view.validate()
        .set_task_instance_id("sv_widgets")
        .handle_errors()
        .with_tracing()
        .partial(
            title="Sum",
            decimal_places=0,
            data=add_more,
            **(params_dict.get("sv_widgets") or {}),
        )
        .call()
    )

    template_dashboard = (
        gather_dashboard.validate()
        .set_task_instance_id("template_dashboard")
        .handle_errors()
        .with_tracing()
        .partial(
            details=workflow_details,
            widgets=sv_widgets,
            time_range=time_range,
            groupers=groupers,
            **(params_dict.get("template_dashboard") or {}),
        )
        .call()
    )

    return template_dashboard
