id: general_report
requirements:
  - name: ecoscope-workflows-core
    version: "0.22.9.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.22.9.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-custom
    version: "0.0.28.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/
    
  - name: ecoscope-workflows-ext-ste
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/
    
rjsf-overrides:
  properties: 
    Subject Group.properties.subject_group_var.properties.var.title: Subject Group Name
    Subject Group.properties.subject_group_var.properties.var.default: Elephants

  $defs:
    # Restrict category options to Subject Name ,Subject Sex and Subject Subtype
    ValueGrouper.properties.index_name.oneOf:
      - const: subject_name
        title: Subject Name

task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
  - name: Set workflow details
    id: workflow_details
    task: set_workflow_details

  - name: Define analysis time range 
    id: time_range 
    task: set_time_range 

  - name: Configure grouping strategy 
    id: groupers 
    task: set_groupers
    partial: 
      groupers: []
  
  - name: Configure base map layers 
    id: configure_base_maps 
    task: set_base_maps_pydeck
    partial:
      base_maps:
        - url: >-
            https://server.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer/tile/{z}/{y}/{x}
          opacity: 1
          max_zoom: 20

  - name: Set previous period range 
    id: set_previous_period
    task: determine_previous_period
    partial: 
      current_time_range: ${{ workflow.time_range.return }}

  - name: Connect to earth ranger
    id: er_client_name
    task: set_er_connection 
  
  - name: Connect to earth engine 
    id: gee_project_name
    task: set_gee_connection 
  
  - title: Subject Group
    type: task-group
    description: Choose subject group to analyze 
    tasks:
      - name: null
        id: subject_group_var
        task: set_string_var

  - name: Choose subject group to analyze 
    id: subject_observations 
    task: get_subjectgroup_observations 
    partial: 
      filter: clean
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      subject_group_name: ${{ workflow.subject_group_var.return }}
      raise_on_empty: false 
      include_details: false 
      include_subjectsource_details: false 

  # Please note that this workflow only uses ldx db 
  - name: Load landDx database
    id: retrieve_ldx_db
    task: get_file_path 
    partial: 
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
  
  - name: Load ldx gpkg 
    id: load_ldx 
    task: load_df 
    partial: 
      file_path: ${{ workflow.retrieve_ldx_db.return }}
      layer: landDx_polygons
      deserialize_json: false 
    
  - name: Filter loaded landDx by AOI 
    id: filter_ldx_aoi 
    task: filter_row_values
    partial: 
      df: ${{ workflow.load_ldx.return }}
      column: type 
      values: 
        - Community Conservancy 
        - National Reserve 
        - National Park
    
  - name: Exclude unnecessary columns from ldx gdf 
    id: filter_ldx_cols 
    task: filter_df_cols 
    partial: 
      df: ${{ workflow.filter_ldx_aoi.return }}
      columns: 
        - type
        - name
        - geometry
    
  - name: Create text layer 
    id: create_ldx_text_layer 
    task: create_custom_text_layer 
    partial: 
      geodataframe: ${{ workflow.filter_ldx_cols.return }}
      layer_style: 
        get_text: name 
        get_color: [20,20,20,255]
        
        get_size: 1000 #1500
        size_units: meters 
        size_min_pixels: 40 #70 
        size_max_pixels: 75 #100
        size_scale: 1.25 #2.25 

        font_family: Arial 
        font_weight: normal
        get_text_anchor: middle 
        get_alignment_baseline: center
        billboard: true 

        background_padding: [4,8]
        pickable: true 
        auto_highlight: false 
      use_centroid: true 
      legend: null 
  
  - name: Split ldx gdf by type column 
    id: split_ldx_by_type 
    task: split_gdf_by_column
    partial: 
      gdf: ${{ workflow.filter_ldx_cols.return }}
      column: type 
  
  - name: Annotate gdf dict with geom type 
    id: annotate_gdf_dict 
    task: annotate_gdf_dict_with_geom_type 
    partial: 
      gdf_dict: ${{ workflow.split_ldx_by_type.return }}

  - name: Create deckgl layers from split ldx gdf dict
    id: create_ldx_styled_layers 
    task: create_deckgl_layers_from_gdf_dict
    partial: 
      gdf_dict: ${{ workflow.annotate_gdf_dict.return }}
      styles: 
        Community Conservancy:
          get_fill_color: [166,182,151]
          get_line_color: [166,182,151]
          opacity: 0.175
          stroked: true
          get_line_width: 2.25 #1.85
          
        National Reserve:
          get_fill_color: [136,167,142]
          get_line_color: [136,167,142]
          opacity: 0.175
          stroked: true
          get_line_width: 2.25

        National Park: 
          get_fill_color: [17, 86, 49]
          get_line_color: [17, 86, 49]
          opacity: 0.175
          stroked: true
          get_line_width: 2.25 # 2.00
    
      legends: 
        title: "Land Use" 
        values: 
          - label: Community Conservancy 
            color: "#a6b697"
          - label: National Reserve 
            color: "#88a78e"
          - label: National Park 
            color: "#115631"

  - name: Transform observations to relocations 
    id: subject_reloc
    task: process_relocations 
    partial: 
      observations: ${{ workflow.subject_observations.return }}
      relocs_columns: 
        - groupby_col
        - fixtime
        - junk_status 
        - geometry
        - extra__subject__name
        - extra__subject__hex
        - extra__subject__sex
        - extra__created_at
        - extra__subject__subject_subtype

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: Annotate relocations with day/night labels
    id: annotate_day_night 
    task: classify_is_night 
    partial: 
      relocations: ${{ workflow.subject_reloc.return }}

  # this enables us to apply trajectory segment filter on both the current and previous trajs
  - name: Trajectory Segment Filter  
    id: custom_trajs_filter
    task: custom_trajectory_segment_filter

  - name: Convert relocations to trajectories 
    id: convert_to_trajectories 
    task: relocations_to_trajectory 
    partial: 
      relocations: ${{ workflow.annotate_day_night.return }}
      trajectory_segment_filter: ${{ workflow.custom_trajs_filter.return }}

  - name: Add temporal index to trajectories 
    id: add_temporal_index_to_traj 
    task: add_temporal_index
    partial: 
      df: ${{ workflow.convert_to_trajectories.return }}
      time_col: segment_start 
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true 
      format: mixed 

  # retrieve previous relocs and trajs based on time range set earlier
  - name: Retrieve previous period observations
    id: previous_observations 
    task: get_subjectgroup_observations 
    partial: 
      filter: clean
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.set_previous_period.return }}
      subject_group_name: ${{ workflow.subject_group_var.return }}
      raise_on_empty: false 
      include_details: false 
      include_subjectsource_details: false
    
  - name: Transform previous observations to relocations 
    id: previous_relocs
    task: process_relocations
    partial: 
      observations: ${{ workflow.previous_observations.return }}
      relocs_columns: 
        - groupby_col
        - fixtime
        - junk_status 
        - geometry
        - extra__subject__name
        - extra__subject__hex
        - extra__subject__sex
        - extra__created_at
        - extra__subject__subject_subtype

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  - name: Annotate previous relocations with day/night labels
    id: annotate_prev_day_night 
    task: classify_is_night 
    partial: 
      relocations: ${{ workflow.previous_relocs.return }}

  - name: Convert  previous relocations to trajectories 
    id: convert_prev_to_trajectories 
    task: relocations_to_trajectory 
    partial: 
      relocations: ${{ workflow.annotate_prev_day_night.return }}
      trajectory_segment_filter: ${{ workflow.custom_trajs_filter.return }}

  - name: Add temporal index to previous trajectories 
    id: add_temporal_prev_index_to_traj 
    task: add_temporal_index
    partial: 
      df: ${{ workflow.convert_prev_to_trajectories.return }}
      time_col: segment_start 
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true 
      format: mixed 

  - name: Rename trajectory columns for previous period  
    id: rename_prev_traj_cols 
    task: map_columns 
    partial:
      raise_if_not_found: true 
      df: ${{ workflow.add_temporal_prev_index_to_traj.return }}
      drop_columns: []
      retain_columns: [] 
      rename_columns: 
        extra__hex: hex_color
        extra__is_night: is_night
        extra__name: subject_name
        extra__sex: subject_sex
        extra__subject_subtype: subject_subtype
        extra__created_at: created_at

  # proceed to further generate a speedmap 
  - name: Classify trajectories by speed 
    id: classify_trajectories_speed_bins 
    task: apply_classification 
    partial: 
      df: ${{ workflow.add_temporal_index_to_traj.return }}
      input_column_name: speed_kmhr
      output_column_name: speed_bins
      classification_options: 
        scheme: equal_interval 
        k: 6 
      label_options:
        label_ranges: true
        label_decimals: 1
        label_suffix: ' km/h'
  
  - name: Rename trajectory columns 
    id: rename_traj_cols 
    task: map_columns 
    partial:
      raise_if_not_found: true
      df: ${{ workflow.classify_trajectories_speed_bins.return }}
      drop_columns: []
      retain_columns: [] 
      rename_columns: 
        extra__hex: hex_color
        extra__is_night: is_night
        extra__name: subject_name
        extra__sex: subject_sex
        extra__subject_subtype: subject_subtype
        extra__created_at: created_at
    
  - name: Persist trajectories as geoparquet 
    id: persist_trajs_geoparquet
    task: persist_df 
    partial: 
      df: ${{ workflow.rename_traj_cols.return }}
      filetype: geoparquet 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: trajectories 
  
  - name: Persist previous period trajectories as geoparquet
    id: persist_prev_trajs_geoparquet
    task: persist_df 
    partial: 
      df: ${{ workflow.rename_prev_traj_cols.return }}
      filetype: geoparquet 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: previous_period_trajectories
  
  - name: Persist relocations as geoparquet 
    id: persist_relocs_geoparquet
    task: persist_df 
    partial: 
      df: ${{ workflow.subject_reloc.return }}
      filetype: geoparquet 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: relocations
    
  - name: Persist previous period relocations as geoparquet 
    id: persist_prev_relocs_geoparquet
    task: persist_df 
    partial: 
      df: ${{ workflow.previous_relocs.return }}
      filetype: geoparquet 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: previous_period_relocations

  - name: Create column for current duration status 
    id: create_current_duration_column 
    task: create_column
    partial:
      df: ${{ workflow.rename_traj_cols.return }}
      col_name: duration_status
      value: Current tracks
    
  - name: Create column for previous duration status
    id: create_previous_duration_column 
    task: create_column
    partial:
      df: ${{ workflow.rename_prev_traj_cols.return }}
      col_name: duration_status
      value: Previous tracks

  # We should merge previous and current trajs here to allow us to draw the movement tracks ecomap easily 
  - name: Merge current - previous trajectories 
    id: merge_current_prev_trajs 
    task: merge_multiple_df 
    partial:
      list_df: 
        - ${{ workflow.create_current_duration_column.return }}
        - ${{ workflow.create_previous_duration_column.return }}
      
      ignore_index: true 
      sort: false

  - name: Assign duration colors 
    id: assign_duration_colors
    task: modify_status_colors
    partial: 
      grouper_value: overall
      gdf: ${{ workflow.merge_current_prev_trajs.return }}

  # 1. Movement tracks 
  - name: Sort trajectories by duration status 
    id: sort_trajs_by_status
    task: sort_values
    partial: 
      column_name: duration_status
      na_position: first 
      ascending: false
      df: ${{ workflow.assign_duration_colors.return }}

  - name: Exclude unnecessary columns from movement gdf 
    id: filter_movement_cols 
    task: filter_df_cols 
    partial: 
      columns: 
        - duration_status
        - duration_status_colors
        - is_night
        - geometry
      df: ${{ workflow.sort_trajs_by_status.return }}

  - name: Create movement track layers
    id: generate_track_layers
    task: create_path_layer
    partial: 
      layer_style:
        get_color: duration_status_colors
        get_width: 2.85
        width_scale: 1 
        width_min_pixels: 2 
        width_max_pixels: 8 
        width_units: pixels
        cap_rounded: true 
        joint_rounded: true
        billboard: false
        opacity: 0.55
        stroked: true 
      legend:
        title: Movement Tracks
        label_column: duration_status
        color_column: duration_status_colors
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.filter_movement_cols.return }}

  - name: Combine ldx layers and movement track layers
    id: combined_ldx_movement_layers
    task: combine_deckgl_map_layers
    partial: 
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
        - ${{ workflow.create_ldx_text_layer.return }}
      grouped_layers: ${{ workflow.generate_track_layers.return }}

  - name: Zoom to gdf extent 
    id: movement_view_state
    task: view_state_deck_gdf
    partial: 
      gdf: ${{ workflow.filter_movement_cols.return }}
      pitch: 0
      bearing: 0 
    
  - name: Draw movement tracks map
    id: draw_movement_tracks
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      view_state: ${{ workflow.movement_view_state.return }}
      geo_layers: ${{ workflow.combined_ldx_movement_layers.return }}

  - name: Persist movement tracks html 
    id: persist_movement_tracks_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: movement_tracks 
      text: ${{ workflow.draw_movement_tracks.return }}

  # 2. Collaring events 
  - name: Retrieve all events 
    id: get_events_data
    task: get_events
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      client: ${{ workflow.er_client_name.return }}
      time_range: ${{ workflow.time_range.return }}
      event_columns:
        - id
        - time
        - event_type
        - event_category
        - reported_by
        - serial_number
        - geometry
        - created_at
        - event_details
      #event_types:
      raise_on_empty: false
      include_details: true
      include_updates: false
      include_related_events: false
      include_null_geometry: false
      include_display_values: false

  - name: Generate elephant collaring locations 
    id: generate_collaring_layers
    task: create_scatterplot_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        get_fill_color: [85, 107, 47]
        get_line_color: [0, 0, 0, 200]
        get_line_width: 0.55
        get_radius: 3.55
        opacity: 0.75
        stroked: true
      legend:
        title: Legend 
        values:
          - label: Elephant sightings 
            color: "#556b2f"
      geodataframe: ${{ workflow.get_events_data.return }}

  - name: Combine ldx layers and collared point layers
    id: combined_ldx_collar_points
    task: combine_deckgl_map_layers
    partial: 
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
        - ${{ workflow.create_ldx_text_layer.return }}
      grouped_layers: ${{ workflow.generate_collaring_layers.return }}

  - name: Zoom to gdf extent 
    id: collaring_view_state
    task: view_state_deck_gdf
    partial: 
      gdf: ${{ workflow.get_events_data.return }}
      pitch: 0
      bearing: 0 

  - name: Draw collaring points map
    id: draw_collared_map
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      view_state: ${{ workflow.collaring_view_state.return }}
      geo_layers: ${{ workflow.combined_ldx_collar_points.return }}

  - name: Persist collared points html 
    id: persist_collared_points_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: collared_points 
      text: ${{ workflow.draw_collared_map.return }}

  # 3. Subject tracks 
  - name: Convert subject hex colors  to rgba colors 
    id: convert_subject_hex_rgba 
    task: convert_hex_to_rgba 
    partial:
      df: ${{ workflow.rename_traj_cols.return }}
      col: hex_color
      new_col: rgba_colors
    
  # subject track layers
  - name: Create subject track layers
    id: generate_strack_layers
    task: create_path_layer
    partial: 
      layer_style:
        get_color: rgba_colors
        get_width: 2.85
        width_scale: 1 
        width_min_pixels: 2 
        width_max_pixels: 8 
        width_units: pixels
        cap_rounded: true 
        joint_rounded: true
        billboard: false
        opacity: 0.55
        stroked: true 
      legend:
        title: Movement Tracks
        label_column: subject_name
        color_column: rgba_colors
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.convert_subject_hex_rgba.return }}

  - name: Combine ldx layers and subject track layers
    id: combined_ldx_subject_layers
    task: combine_deckgl_map_layers
    partial: 
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
        - ${{ workflow.create_ldx_text_layer.return }}
      grouped_layers: ${{ workflow.generate_strack_layers.return }}

  - name: Zoom to gdf extent 
    id: tracks_view_state
    task: view_state_deck_gdf
    partial: 
      gdf: ${{ workflow.convert_subject_hex_rgba.return }}
      pitch: 0
      bearing: 0 

  - name: Draw subject tracks map
    id: draw_subject_tracks
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      view_state: ${{ workflow.tracks_view_state.return }}
      geo_layers: ${{ workflow.combined_ldx_subject_layers.return }}

  - name: Persist subject tracks html 
    id: persist_subject_tracks_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: subject_tracks 
      text: ${{ workflow.draw_subject_tracks.return }}

  #4 . Home range 
  - name: Generate etd 
    id: generate_etd 
    task: calculate_elliptical_time_density
    partial: 
      auto_scale_or_custom_cell_size: 
        auto_scale_or_customize: Auto-scale      
      crs: ESRI:53042
      percentiles: 
        - 50.0 
        - 60.0 
        - 70.0
        - 80.0
        - 90.0
        - 95.0
        - 99.9
      nodata_value: nan 
      band_count: 1
      max_speed_factor: 1.05 
      expansion_factor: 1.3
      trajectory_gdf: ${{ workflow.rename_traj_cols.return }}

  - name: Persist etd gdf
    id: persist_etd_gdf
    task: persist_df 
    partial: 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filetype: geoparquet
      filename: home_range_etd
      df: ${{ workflow.generate_etd.return }}

  - name: Determine seasonal windows 
    id: determine_seasonal_windows 
    task: custom_determine_season_windows
    partial: 
      client: ${{ workflow.gee_project_name.return }}
      time_range: ${{ workflow.time_range.return }}
      roi: ${{ workflow.generate_etd.return }}
  
  - name: Persist seasonal windows csv 
    id: persist_ndvi_values
    task: persist_df 
    partial: 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filetype: csv
      filename: seasonal_windows
      df: ${{ workflow.determine_seasonal_windows.return }}

  - name: Create seasonal labels 
    id: add_season_labels
    task: create_seasonal_labels
    partial: 
      seasons_df: ${{ workflow.determine_seasonal_windows.return }}
      trajectories: ${{ workflow.rename_traj_cols.return }}
  
  - name: Apply colormap to home range percentiles 
    id: apply_etd_colormap 
    task: apply_color_map
    partial: 
      input_column_name: percentile
      output_column_name: etd_percentile_colors
      colormap: RdYlGn
      df: ${{ workflow.generate_etd.return }}

  - name: Create home range layers 
    id: generate_home_range_layers 
    task: create_geojson_layer
    partial: 
      layer_style: 
        filled: true 
        stroked: true 
        extruded: false 
        wireframe: false
        get_fill_color: etd_percentile_colors
        get_line_color: etd_percentile_colors
        opacity: 0.55 
        get_line_width: 1.55
        get_elevation: 0
        get_point_radius: 1
        line_width_units: pixels 
        line_width_scale: 1 
        line_width_min_pixels: 1
        line_width_max_pixels: 5

      legend: 
        title: Home Range Percentiles
        label_column: percentile
        color_column: etd_percentile_colors
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.apply_etd_colormap.return }}

  - name: Combine ldx layers and home range layers
    id: combined_ldx_home_range_layers 
    task: combine_deckgl_map_layers
    partial: 
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
        - ${{ workflow.create_ldx_text_layer.return }}
      grouped_layers: ${{ workflow.generate_home_range_layers.return }}
  
  - name: Zoom to gdf extent 
    id: overall_hr_view_state
    task: view_state_deck_gdf
    partial: 
      gdf: ${{ workflow.apply_etd_colormap.return }}
      pitch: 0
      bearing: 0 

  - name: Draw home range map
    id: draw_home_range_map
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      geo_layers: ${{ workflow.combined_ldx_home_range_layers.return }}
      view_state: ${{ workflow.overall_hr_view_state.return }}

  - name: Persist homerange html 
    id: persist_homerange_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: overall_homerange
      text: ${{ workflow.draw_home_range_map.return }}
    

  #5. 99th percentile hr 
  - name: Filter etd to 99th percentile 
    id: filter_percentile 
    task: filter_df_values 
    partial: 
      column_name: percentile 
      op: ge
      value: 99.0
      df: ${{ workflow.generate_etd.return }}
      reset_index: true 

  - name: Create 99 home range layers 
    id: custom_home_range_layers 
    task: create_geojson_layer
    partial: 
      layer_style: 
        filled: true 
        stroked: true 
        extruded: false 
        wireframe: false
        get_fill_color: [210, 105, 30]
        get_line_color: [210, 105, 30]
        opacity: 0.55 
        get_line_width: 1.55
        get_elevation: 0
        get_point_radius: 1
        line_width_units: pixels 
        line_width_scale: 1 
        line_width_min_pixels: 1
        line_width_max_pixels: 5

      legend: 
        title: Home Range Percentiles
        values: 
          - label: 99th percentile 
            color: "#d2691e"
      geodataframe: ${{ workflow.filter_percentile.return }}

  - name: Combine ldx layers and filtered home range layers
    id: combined_ldx_filtered_hr_layers 
    task: combine_deckgl_map_layers
    partial: 
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
        - ${{ workflow.create_ldx_text_layer.return }}
      grouped_layers: ${{ workflow.custom_home_range_layers.return }}
  
  - name: Zoom to gdf extent 
    id: filtered_hr_view_state
    task: view_state_deck_gdf
    partial: 
      gdf: ${{ workflow.filter_percentile.return }}
      pitch: 0
      bearing: 0 

  - name: Draw filtered home range map
    id: draw_filtered_hr_map
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      geo_layers: ${{ workflow.combined_ldx_filtered_hr_layers.return }}
      view_state: ${{ workflow.filtered_hr_view_state.return }}

  - name: Persist homerange html 
    id: persist_filtered_hr_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: filtered_homerange
      text: ${{ workflow.draw_filtered_hr_map.return }}

  # 6. Recursion events raster
  - name: Generate recursion events raster
    id: generate_recursion_raster
    task: generate_ecograph_raster
    partial:
      step_length: 2000 
      dist_col: dist_meters 
      interpolation: mean 
      movement_covariate: null 
      radius: 2 
      cutoff: null 
      tortuosity_length: 3 
      resolution: null 
      network_metric: weight 
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: weighted_raster
      gdf: ${{ workflow.add_season_labels.return }}

  - name: Extract features from raster 
    id: extract_raster 
    task: retrieve_feature_gdf 
    partial: 
      file_path: ${{ workflow.generate_recursion_raster.return }}

  - name: Sortfeatures by value 
    id: sort_recursion_features
    task: sort_values 
    partial: 
      column_name: value
      na_position: last 
      ascending: true 
      df: ${{ workflow.extract_raster.return }}

  - name: Classify recursion gdfs
    id: classify_recursion_features
    task: apply_classification
    partial:
      input_column_name: value
      output_column_name: bins
      classification_options:
        scheme: natural_breaks
        k: 6
      label_options:
        label_ranges: false  
        label_decimals: 1
      df: ${{ workflow.sort_recursion_features.return }}

  - name: Apply colormap to recursion bins
    id: apply_recursion_colormap
    task: apply_color_map
    partial:
      input_column_name: bins
      output_column_name: recursion_bins_colors
      colormap:
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
      df: ${{ workflow.classify_recursion_features.return }}

  - name: Create recursion events layers 
    id: generate_recursion_layers 
    task: create_geojson_layer
    partial: 
      layer_style: 
        filled: true 
        stroked: true 
        extruded: false 
        wireframe: false
        get_fill_color: recursion_bins_colors
        get_line_color: recursion_bins_colors
        opacity: 0.55 
        get_line_width: 1.55
        get_elevation: 0
        get_point_radius: 1
        line_width_units: pixels 
        line_width_scale: 1 
        line_width_min_pixels: 1
        line_width_max_pixels: 5

      legend: 
        title: Recursion events
        label_column: bins
        color_column: recursion_bins_colors
        sort: ascending 
        label_suffix: null
      geodataframe: ${{ workflow.apply_recursion_colormap.return }}

  - name: Combine ldx layers and recursion events layers
    id: combined_ldx_recursion_layers 
    task: combine_deckgl_map_layers
    partial: 
      static_layers: 
        - ${{ workflow.create_ldx_styled_layers.return }}
        - ${{ workflow.create_ldx_text_layer.return }}
      grouped_layers: ${{ workflow.generate_recursion_layers.return }}
  
  - name: Zoom to gdf extent 
    id: recursion_view_state
    task: view_state_deck_gdf
    partial: 
      gdf: ${{ workflow.apply_recursion_colormap.return }}
      pitch: 0
      bearing: 0 

  - name: Draw recursion events map
    id: draw_recursion_map
    task: draw_map 
    partial: 
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      title: null 
      max_zoom: 10
      legend_style: 
        placement: bottom-right
      geo_layers: ${{ workflow.combined_ldx_recursion_layers.return }}
      view_state: ${{ workflow.recursion_view_state.return }}

  - name: Persist recursion events html 
    id: persist_recursion_html
    task: persist_text 
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename_suffix: recursion_events
      text: ${{ workflow.draw_recursion_map.return }}

  - name: Persist seasonal trajectories as geoparquet 
    id: persist_strajs_geoparquet
    task: persist_df 
    partial: 
      df: ${{ workflow.add_season_labels.return }}
      filetype: geoparquet 
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: seasonal_trajectories 

  - name: Persist seasonal trajectories as csv
    id: persist_strajs_csv
    task: persist_df 
    partial: 
      df: ${{ workflow.add_season_labels.return }}
      filetype: csv
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: seasonal_trajectories 

# 6. Seasonal homerange 
  

  - name: Mapbook dashboard 
    id: mapbook_dashboard 
    task: gather_dashboard 
    partial: 
      details: ${{ workflow.workflow_details.return }}
      widgets: []
      time_range: ${{ workflow.time_range.return }}
      groupers: ${{ workflow.groupers.return }}