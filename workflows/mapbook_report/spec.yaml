id: mapbook_report
requirements:
  - name: ecoscope-workflows-core
    version: "0.18.0.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.18.0.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ste
    version: "*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-custom
    version: "0.0.7.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

rjsf-overrides:
  properties:
    Subject Group.properties.subject_observations.properties.subject_group_name.ecoscope:subject_group_name: properties.er_client_name.properties.data_source.properties.name
  $defs:
    ValueGrouper.oneOf:
      - const: subject_name
        title: Subject Name
      - const: subject_sex 
        title: Subject Sex
      - const: subject_subtype
        title: Subject Subtype

task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
# set workflow metadata
  - name: Initialize workflow metadata
    id: initialize_workflow_metadata
    task: set_workflow_details

  # define workflow time range
  - name: Define time range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"
      timezone: 
        label: UTC 
        tzCode: UTC 
        name: UTC 
        utc_offset: "+00:00"

  # configure dynamic grouping strategy --> for this workflow, by subject name
  - name: Configure grouping strategy
    id: groupers
    task: set_groupers

  # define base map layers
  - name: Configure base map layers
    id: configure_base_maps
    task: set_base_maps
  
  # Download cover template
  - name: Download mapbook cover page templates
    id: download_mapbook_cover_page
    task: fetch_and_persist_file
    partial:
      url: https://www.dropbox.com/scl/fi/1373gi65ji918rxele5h9/cover_page_v3.docx?rlkey=ur01wtpa98tcyq8f0f6dtksl8&st=eq39sgwz&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
      unzip: false
      retries: 3

  # Download section templates
  - name: Download mapbook section templates
    id: download_sect_templates
    task: fetch_and_persist_file
    partial:
      url: https://www.dropbox.com/scl/fi/0as1u7uuhia7emp5cqxfl/mapbook_subject_template_v6.docx?rlkey=4nzn4qa2hu0v3fqo8bpki4tgu&st=kco28x6g&dl=0
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false
      unzip: false
      retries: 3

  # Download Logo
  - name: Download logo path 
    id: download_logo_path
    task: fetch_and_persist_file
    partial:
      url: "https://www.dropbox.com/scl/fi/1gn84pq9c7tedgg3k90qt/save-the-elephants.jpg?rlkey=ump7g2hcc2pn0pd5nst203c7w&st=jlwbhik9&dl=0"
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      overwrite_existing: false 
      unzip: false
      retries: 3

  # 1. Download landdx database,split by type, create styled layers
  # download LandDx database, unzip, and save to output directory
  - name: Download landDx db and extract
    id: download_ldx_db
    task: fetch_and_persist_file
    partial:
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      url: "https://maraelephant.maps.arcgis.com/sharing/rest/content/items/6da0c9bdd43d4dd0ac59a4f3cd73dcab/data"
      overwrite_existing: false
      unzip: true
      retries: 3

  - name: Find landDx gpkg path
    id: return_ldx_path
    task: find_landdx_gpkg_path
    partial:
      output_dir: ${{ workflow.download_ldx_db.return }}

  # Load AOI from LandDx 
  - name: Load landDx gpkg 
    id: load_landdx
    task: load_df 
    partial: 
      file_path: ${{ workflow.return_ldx_path.return }}
      layer: landDx_polygons 
      deserialize_json: false 
  
  # Filter LandDx AOI by type
  - name: Filter loaded landDX by AOI 
    id: filter_landdx_aoi 
    task: filter_by_value
    partial: 
      df: ${{ workflow.load_landdx.return }}
      column_name: type 
      value: 
        - Community Conservancy
        - National Reserve
        - National Park

  # create text layer from filtered aoi
  - name : Create text layer from filtered aoi 
    id: custom_text_layer 
    task: make_text_layer 
    partial:
      txt_gdf: ${{ workflow.filter_landdx_aoi.return }}
      label_column: label
      name_column: name
      use_centroid: true
      color: [0, 0, 0, 255]
      size: 16
      font_weight: normal
      font_family: Arial
      text_anchor: middle
      alignment_baseline: center
      pickable: true
      tooltip_columns: null 
      zoom: false
      target_crs: epsg:4326

  # split LandDx AOI features by 'type' column
  - name: Split landDx layers by type
    id: split_landdx_by_type
    task: split_gdf_by_column
    partial:
      gdf: ${{ workflow.filter_landdx_aoi.return }}
      column: type

  # annotate each LandDx AOI layer with its geometry type
  - name: Annotate geometry types to landdx dicts
    id: annotate_geometry_types
    task: annotate_gdf_dict_with_geometry_type
    partial:
      gdf_dict: ${{ workflow.split_landdx_by_type.return }}

  # create styled map layers for LandDx features
  - name: Style landDx map layers
    id: create_styled_landdx_layers
    task: create_map_layers_from_annotated_dict
    partial:
      annotated_dict: ${{ workflow.annotate_geometry_types.return }}
      style_config:
        styles:
          Community Conservancy:
            get_fill_color: [85, 107, 47]
            get_line_color: [85, 107, 47]
            opacity: 0.15
            stroked: true
            get_line_width: 1.55
          
          National Reserve:
            get_fill_color: [143, 188, 139]
            get_line_color: [143, 188, 139]
            opacity: 0.15
            stroked: true
            get_line_width: 1.55

          National Park: 
            get_fill_color: [255, 250, 205]
            get_line_color: [255, 250, 205]
            opacity: 0.15
            stroked: true
            get_line_width: 1.55

        legend:
          labels: ["Community Conservancy","National Reserve", "National Park"]
          colors: ["#556b2f","#8fbc8b","#fffacd"]

  # 2. Connect to earthranger , engine  and retrieve subject observations 
  # Connect to ER
  - name: Connect to ER instance
    id: er_client_name
    task: set_er_connection
  
  #Connect to EE
  - name: Connect to EE
    id: gee_project_name
    task: set_gee_connection

  - title: Subject Group
    type: task-group
    description: Choose a subject group to analyze
    tasks:
      - name: null
        id: subject_observations
        task: get_subjectgroup_observations
        partial:
          client: ${{ workflow.er_client_name.return }}
          time_range: ${{ workflow.time_range.return }}
          raise_on_empty: false
          include_details: false
          include_subjectsource_details: false
  
  - name: Transform observations to relocations
    id: subject_reloc
    task: process_relocations
    partial:
      observations: ${{ workflow.subject_observations.return }}
      relocs_columns:
        - groupby_col
        - fixtime
        - junk_status 
        - geometry
        - extra__subject__name
        - extra__subject__hex
        - extra__subject__sex
        - extra__created_at
        - extra__subject__subject_subtype

      filter_point_coords:
        - x: 180.000000
          y: 90.000000
        - x: 0.000000
          y: 0.000000
        - x: 1.000000
          y: 1.000000

  # classify relocations as day or night
  - name: Annotate relocations with Day/Night Labels
    id: annotate_day_night
    task: classify_is_night
    partial:
      relocations: ${{ workflow.subject_reloc.return }}

  # convert subject relocations to movement trajectories
  - name: Convert relocations to trajectories
    id: convert_to_trajectories
    task: relocations_to_trajectory
    partial:
      relocations: ${{ workflow.annotate_day_night.return }}

  # add temporal index to subject trajectories using segment_start
  - name: Add temporal index to trajectories
    id: add_temporal_index_to_traj
    task: add_temporal_index
    partial:
      df: ${{ workflow.convert_to_trajectories.return }}
      time_col: segment_start
      groupers: ${{ workflow.groupers.return }}
      cast_to_datetime: true
      format: mixed

  # classify trajectories into speed bins
  - name: Classify trajectories by speed
    id: classify_trajectory_speed_bins
    task: apply_classification
    partial:
      df: ${{ workflow.add_temporal_index_to_traj.return }}
      input_column_name: speed_kmhr
      output_column_name: speed_bins
      classification_options:
        scheme: equal_interval
        k: 6
      label_options:
        label_ranges: false  
        label_decimals: 1

  # classify trajectories by quarterly time periods
  - name: Label trajectories by quarter
    id: label_trajectory_quarters
    task: label_quarter_status
    partial:
      gdf: ${{ workflow.classify_trajectory_speed_bins.return }}
      timestamp_col: segment_start



  # rename trajectory columns
  - name: Rename trajectory columnns
    id: rename_traj_cols
    task: map_columns
    partial:
      drop_columns: []
      retain_columns: []
      rename_columns:
        extra__hex: hex_color
        extra__is_night: is_night
        extra__name: subject_name
        extra__sex: subject_sex
        extra__subject_subtype: subject_subtype
        extra__created_at: created_at

      df: ${{ workflow.label_trajectory_quarters.return }}

  # persist trajectories and relocations
  - name: Persist trajectories as gpkg
    id: persist_trajectory_df
    task: persist_df 
    partial:
      df: ${{ workflow.rename_traj_cols.return }}
      filetype: "gpkg"
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: trajectories

  - name: Persist relocations as gpkg
    id: persist_relocs_df
    task: persist_df
    partial:
      df: ${{ workflow.annotate_day_night.return }}
      filetype: "gpkg"
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: relocations

  # split subject trajectories into groups based on grouping strategy
  - name: Split trajectories by group
    id: split_trajectories_by_group
    task: split_groups
    partial:
      df: ${{ workflow.rename_traj_cols.return }}
      groupers: ${{ workflow.groupers.return }}

  - name: Get subject group names
    id: split_group_column
    task: get_split_group_column
    partial:
      split_data: 
        - ${{ workflow.split_trajectories_by_group.return }}

  - name: Assign quarter status colors
    id: assign_quarter_colors_traj
    task: modify_quarter_status_colors
    partial:
      grouper_value: ${{ workflow.split_group_column.return }}
    mapvalues: 
      argnames: gdf
      argvalues: ${{ workflow.split_trajectories_by_group.return}}

  # 1.SPEEDMAP
  # sort grouped trajectories by speed classification
  - name: Sort trajectories by speed bins
    id: sort_trajectories_by_speed
    task: sort_values
    partial:
      column_name: speed_bins
      na_position: last
      ascending: true
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  # apply color mapping to trajectories based on speed bins
  - name: Apply colormap to speed bins
    id: apply_speed_colormap
    task: apply_color_map
    partial:
      input_column_name: speed_bins
      output_column_name: speed_bins_colormap
      colormap:
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.sort_trajectories_by_speed.return }}

  # format speed bin labels for legend with units
  - name: Format speed bins for legend
    id: format_speed_bin_labels
    task: map_values_with_unit
    partial:
      input_column_name: speed_bins
      output_column_name: speed_bins_formatted
      original_unit: km/h
      new_unit: km/h
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.apply_speed_colormap.return }}

  # format raw speed values for display with units
  - name: Format speed values for display
    id: format_speed_values
    task: map_values_with_unit
    partial:
      input_column_name: speed_kmhr
      output_column_name: speed_kmhr
      original_unit: km/h
      new_unit: km/h
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.format_speed_bin_labels.return }}

  # Generate speedmap polyline layers
  - name: Generate speedmap layers
    id: generate_speedmap_layers
    task: create_polyline_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        color_column: speed_bins_colormap
      legend:
        label_column: speed_bins_formatted
        color_column: speed_bins_colormap
      tooltip_columns:
        - is_night
        - subject_name
        - segment_start
        - dist_meters
        - timespan_seconds
        - subject_sex
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.format_speed_values.return }}

  - name: Zoom speed trajs by view state
    id: zoom_speed_traj_view
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.format_speed_values.return }}

  # combine static LandDx layers with speed ecomap trajectory layers
  - name: Combine landDx and speedmap layers
    id: ldx_speed_layers
    task: combine_map_layers
    partial:
      static_layers: 
        - ${{ workflow.create_styled_landdx_layers.return }}
        - ${{ workflow.custom_text_layer.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.generate_speedmap_layers.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip speedmap layers and zoom values
    id: zip_speed_zoom_values
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.ldx_speed_layers.return }} # geo_layers
      right: ${{ workflow.zoom_speed_traj_view.return }} # view_state

  # draw speed ecomap for each traj group
  - name: Draw Speepmap by group
    id: draw_speed_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Speed Values(Km/h)
      static: false
      title: null
      max_zoom: 12
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.zip_speed_zoom_values.return }}

  # persist HTML URLs of speed ecomaps as text files
  - name: Persist speedmap HTML paths
    id: persist_speed_ecomap_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.draw_speed_ecomap.return }}

  # create single-view map widgets for speed trajectory ecomaps
  - name: Create speedmap widgets
    id: create_speedmap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Speedmap
    map:
      argnames:
        - view 
        - data
      argvalues: ${{ workflow.persist_speed_ecomap_urls.return }}

  # merge individual speed ecomap widgets into a grouped view
  - name: Merge speedmap widgets
    id: merge_speedmap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.create_speedmap_widgets.return }}

  # 2.DAY/NIGHT ECOMAPS
  # sort trajectories by night/day classification
  - name: Sort trajectories by Night/Day
    id: sort_trajs_by_day_night
    task: sort_values
    partial:
      column_name: is_night
      ascending: false
      na_position: last
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  # apply color to trajectories based on day/night classification
  - name: Apply color to trajectories by Day/Night
    id: apply_day_night_colormap
    task: apply_color_map
    partial:
      colormap:
        - '#292965'  # Night
        - '#e7a553'  # Day 
      input_column_name: is_night
      output_column_name: day_night_colors
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.sort_trajs_by_day_night.return }}

  # create polyline map layers for trajectories colored by day/night
  - name: Create Day/Night ecomap layers
    id: generate_day_night_ecomap_layers
    task: create_polyline_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        color_column: day_night_colors
      legend:
        labels:
          - Night
          - Day
        colors:
          - '#292965'
          - '#e7a553'
      tooltip_columns:
        - is_night 
        - subject_name 
        - subject_sex
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.apply_day_night_colormap.return }}

  - name: Zoom day/night trajs by view state
    id: zoom_dn_view
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.apply_day_night_colormap.return }}

  # combine static LandDx layers with day/night ecomap trajectory layers
  - name: Combine landDx and Day/Night ecomap layers
    id: ldx_dn_layers
    task: combine_map_layers
    partial:
      static_layers: 
        - ${{ workflow.create_styled_landdx_layers.return }}
        - ${{ workflow.custom_text_layer.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.generate_day_night_ecomap_layers.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip day/night layers and zoom values
    id: dn_view_zip
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.ldx_dn_layers.return }}
      right: ${{ workflow.zoom_dn_view.return }}

  # draw day/night ecomaps for each trajectory group
  - name: Draw Day/Night ecomaps by group
    id: draw_day_night_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Night Day Tracks
      static: false
      title: null
      max_zoom: 12
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.dn_view_zip.return }}

  # persist HTML URLs of day/night ecomaps as text files
  - name: Persist Day/Night ecomap HTML paths
    id: persist_day_night_ecomap_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.draw_day_night_ecomap.return }}

  # create single-view map widgets for day/night trajectory ecomaps
  - name: Create Day/Night ecomap widgets
    id: create_day_night_ecomap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Night Day Tracks
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.persist_day_night_ecomap_urls.return }}

  # merge day/night ecomap widgets into a grouped view
  - name: Merge Day/Night ecomap widgets
    id: merge_day_night_ecomap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.create_day_night_ecomap_widgets.return }}

  # 3. PREVIOUS/CURRENT QUARTER MOVEMENT TRACKS
  # sort trajectories by previous/current quarter status
  - name: Sort trajectories by quarter status
    id: sort_trajs_by_quarter_status
    task: sort_values
    partial:
      column_name: quarter_status
      ascending: false
      na_position: last
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  # create polyline map layers for trajectories colored by quarter status
  - name: Create quarter status ecomap layers
    id: generate_quarter_ecomap_layers
    task: create_polyline_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        color_column: quarter_status_colors
      legend:
        label_column: quarter_status
        color_column: quarter_status_colors
      tooltip_columns:
        - is_night 
        - subject_name
        - subject_sex 
        - quarter_status
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.sort_trajs_by_quarter_status.return }}

  - name: Zoom quarter movement trajectories by view state
    id: zoom_qm_view
    task: create_view_state_from_gdf
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.format_speed_values.return }}

  # combine static LandDx layers with quarter status movement ecomap layers
  - name: Combine landDx and quarter status ecomap layers
    id: combine_quarter_ecomap_layers
    task: combine_map_layers
    partial:
      static_layers: 
        - ${{ workflow.create_styled_landdx_layers.return }}
        - ${{ workflow.custom_text_layer.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.generate_quarter_ecomap_layers.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip quarter movement layers and zoom values
    id: qm_view_zip
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.combine_quarter_ecomap_layers.return }}
      right: ${{ workflow.zoom_qm_view.return }}

  # draw previous/current quarter movement ecomaps for each trajectory group
  - name: Draw quarter status ecomaps by group
    id: draw_quarter_status_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Legend
      static: false
      title: null
      max_zoom: 12
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.qm_view_zip.return }}

  # persist HTML URLs of quarter status ecomaps as text files
  - name: Persist quarter status ecomap HTML paths
    id: persist_quarter_ecomap_urls
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.draw_quarter_status_ecomap.return }}

  # create single-view map widgets for quarter status ecomaps
  - name: Create quarter status ecomap widgets
    id: create_quarter_ecomap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Movement Overview
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.persist_quarter_ecomap_urls.return }}

  # merge quarter status ecomap widgets into a grouped view
  - name: Merge quarter status ecomap widgets
    id: merge_quarter_ecomap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.create_quarter_ecomap_widgets.return }}

  # 4.HOME RANGE ETD ECOMAP
  # generate elliptical time density (ETD) home range maps per group
  - name: Generate Home Range ecomap
    id: generate_etd
    task: calculate_elliptical_time_density
    partial:
      auto_scale_or_custom_cell_size:
        auto_scale_or_custom: Customize
        grid_cell_size: 2000

      crs: ESRI:53042
      percentiles:
        - 50.0
        - 60.0
        - 70.0
        - 80.0
        - 90.0
        - 95.0
        - 99.9
      nodata_value: nan
      band_count: 1
      max_speed_factor : 1.05
      expansion_factor : 1.3
    mapvalues:
      argnames: trajectory_gdf
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  - name: Determine seasonal windows 
    id: determine_seasonal_windows
    task: determine_season_windows
    skipif:
      conditions: 
      - any_is_empty_df
      - any_dependency_skipped
    partial:
      client: ${{ workflow.gee_project_name.return }}
      time_range: ${{ workflow.time_range.return }}
    mapvalues:
      argnames: roi 
      argvalues: ${{ workflow.generate_etd.return }}
  
  - name: Zip etd and grouped trajectories
    id: zip_etd_and_grouped_trajs
    task: zip_grouped_by_key
    skipif:
      conditions: 
      - any_is_empty_df
      - any_dependency_skipped
    partial:
      left: ${{ workflow.determine_seasonal_windows.return }}
      right: ${{ workflow.assign_quarter_colors_traj.return }}

  # add seasonal labels to grouped trajectories
  - name: Generate seasonal labels
    id: add_season_labels
    task: create_seasonal_labels
    skipif:
      conditions: 
      - any_is_empty_df
      - any_dependency_skipped
    mapvalues:
      argnames:
        - seasons_df
        - trajectories
      argvalues: ${{ workflow.zip_etd_and_grouped_trajs.return }}

  - name: Generate MCP gdf 
    id: calculate_mcp
    task: generate_mcp_gdf
    partial:
      planar_crs: ESRI:53042
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  # apply colormap to ETD home range percentiles
  - name: Apply colormap to Home Range percentiles
    id: apply_etd_percentile_colormap
    task: apply_color_map
    skipif:
      conditions: 
      - any_is_empty_df
      - any_dependency_skipped

    partial:
      input_column_name: percentile
      colormap: RdYlGn
      output_column_name: percentile_colormap
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.generate_etd.return }}

  # create polygon map layers from ETD (home range) percentiles
  - name: Create Home Range ecomap layers
    id: generate_etd_ecomap_layers
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        fill_color_column: percentile_colormap
        opacity: 0.55
      legend:
        label_column: percentile
        color_column: percentile_colormap
      tooltip_columns:
        - percentile
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.apply_etd_percentile_colormap.return }}

  # create polygon map layers for MCP
  - name: Create MCP polygon layer 
    id: generate_mcp_layers
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        get_fill_color: '#FFFFFF00' # transparent fill
        get_line_color: '#ff1493'
        get_line_width: 3.55
        opacity: 0.75
        stroked: true
      legend:
        labels: 
          - MCP
        colors: 
          - '#ff1493'
      tooltip_columns:
        - area_km2
      
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.calculate_mcp.return }}

  - name: Zoom hr movement by view state
    id: zoom_hr_view
    task: create_view_state_from_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.apply_etd_percentile_colormap.return }}

  # zip layers to include both hr and mcp 
  - name: zip mcp and hr
    id: zip_mcp_hr
    task: zip_grouped_by_key
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      left: ${{ workflow.generate_mcp_layers.return }}
      right: ${{ workflow.generate_etd_ecomap_layers.return }}

  # combine static LandDx layers with home range (ETD) ecomap layers
  - name: Combine landDx and Home Range ecomap layers
    id: combine_landdx_hr_ecomap_layers
    task: combine_map_layers
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      static_layers: 
        - ${{ workflow.create_styled_landdx_layers.return }}
        - ${{ workflow.custom_text_layer.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.zip_mcp_hr.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip hr layers and zoom values
    id: hr_view_zip
    task: zip_grouped_by_key
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      left:  ${{ workflow.combine_landdx_hr_ecomap_layers.return }}
      right: ${{ workflow.zoom_hr_view.return }}

  # draw home range (ETD) ecomaps for each subject group
  - name: Draw Home Range ecomap
    id: draw_hr_ecomap
    task: draw_ecomap
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: ETD Metrics
      static: false
      title: null
      max_zoom: 12
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.hr_view_zip.return }}

  # persist HTML URLs of home range ecomaps as text files
  - name: Persist Home Range ecomap HTML paths
    id: persist_hr_ecomap_urls
    task: persist_text
    skipif:
      conditions:
        - any_dependency_skipped
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text 
      argvalues: ${{ workflow.draw_hr_ecomap.return }}

  # create single-view map widgets for home range ecomaps
  - name: Create Home Range ecomap widgets
    id: create_hr_ecomap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Home Range
    map:
      argnames:
        - view 
        - data
      argvalues: ${{ workflow.persist_hr_ecomap_urls.return }}

  # merge home range ecomap widgets into a grouped view
  - name: Merge Home Range ecomap widgets
    id: merge_hr_ecomap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.create_hr_ecomap_widgets.return }}

  # 5.MEAN SPEED RASTER ECOMAP
  # generate mean speed raster for each subject trajectory group
  - name: Generate speed rasters
    id: generate_speed_raster
    task: generate_ecograph_raster
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      step_length: 2000
      dist_col: dist_meters
      interpolation: mean
      movement_covariate: speed
      radius: 2
      cutoff: null
      tortuosity_length : 3
      resolution: null
      network_metric: null
      output_dir: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      filename: null 
    mapvalues:
      argnames: gdf 
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  # extract feature GeoDataFrame from generated speed raster TIFFs
  - name: Extract features from speed raster TIFFs
    id: extract_speed_rasters
    task: retrieve_feature_gdf
    skipif:
      conditions:
        - any_dependency_skipped
    mapvalues:
      argnames: file_path
      argvalues: ${{ workflow.generate_speed_raster.return }}

  # sort extracted speed features by raster value
  - name: Sort speed features by value
    id: sort_speed_features_by_value
    task: sort_values
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      column_name: value
      na_position: last
      ascending: true
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.extract_speed_rasters.return }}

  # apply classification to sorted speed feature GeoDataFrames
  - name: Classify speed feature gdf
    id: classify_speed_features
    task: apply_classification
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      input_column_name: value
      output_column_name: bins
      classification_options:
        scheme: natural_breaks
        k: 6
      label_options:
        label_ranges: false
        label_decimals: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.sort_speed_features_by_value.return }}

  # apply color map to classified speed raster features
  - name: Apply colormap to speed raster bins
    id: apply_speed_raster_colormap
    task: apply_color_map
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      input_column_name: bins
      output_column_name: speedraster_bins_colors
      colormap:
        - '#1a9850'
        - '#91cf60'
        - '#d9ef8b'
        - '#fee08b'
        - '#fc8d59'
        - '#d73027'
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.classify_speed_features.return }}
      
  # format speed raster bin labels for legend display
  - name: Format speed raster bin labels
    id: format_speed_raster_labels
    task: map_values_with_unit
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      input_column_name: bins
      output_column_name: bins_formatted
      original_unit: km/h
      new_unit: km/h
      decimal_places: 1
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.apply_speed_raster_colormap.return }}

  # create polygon map layers from classified speed raster features
  - name: Create speed raster map layers
    id: generate_raster_layers
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style: 
        fill_color_column: speedraster_bins_colors
        opacity: 0.55
      legend:
        label_column: bins_formatted
        color_column: speedraster_bins_colors
      tooltip_columns:
          - value
          - bins
          - speedraster_bins_colors

    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.format_speed_raster_labels.return }}

  - name: Zoom speed rasters by view state
    id: zoom_speedraster_view
    task: create_view_state_from_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.format_speed_raster_labels.return }}

  # combine static LandDx layers with seasonal raster-based ecomap layers
  - name: Combine landDx and speedraster map layers
    id: combine_seasonal_raster_layers
    task: combine_map_layers
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      static_layers: 
        - ${{ workflow.create_styled_landdx_layers.return }}
        - ${{ workflow.custom_text_layer.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.generate_raster_layers.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip speedraster layers and zoom values
    id: speedraster_view_zip
    task: zip_grouped_by_key
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      left:  ${{ workflow.combine_seasonal_raster_layers.return }}
      right: ${{ workflow.zoom_speedraster_view.return }}

  # draw speed raster ecomaps for each trajectory group
  - name: Draw speedraster ecomaps by group
    id: draw_speed_raster_ecomaps
    task: draw_ecomap
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Mean Speed Value (km/h)
      static: false
      title: null
      max_zoom: 12
    mapvalues:
      argnames: 
        - geo_layers
        - view_state
      argvalues: ${{ workflow.speedraster_view_zip.return }}

  # persist HTML URLs of speed raster ecomaps as text files
  - name: Persist speedraster ecomap HTML paths
    id: speed_raster_ecomap_urls
    task: persist_text
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
    mapvalues:
      argnames: text
      argvalues: ${{ workflow.draw_speed_raster_ecomaps.return }}

  # create single-view map widgets for speed raster ecomaps
  - name: Create speedraster ecomap widgets
    id: speed_raster_ecomap_widgets
    task: create_map_widget_single_view
    skipif:
      conditions:
        - never
    partial: 
      title: Speed Raster Ecomap 
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.speed_raster_ecomap_urls.return }}

  # merge speed raster ecomap widgets into a grouped view
  - name: Merge speed raster ecomap widgets
    id: speedraster_ecomap_widgets
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.speed_raster_ecomap_widgets.return }}

  # 6. SEASONAL ECOMAPS
  - name: Calculate seasonal home range 
    id: seasonal_home_range
    task: calculate_seasonal_home_range
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
        - all_geometry_are_none
    partial:
      groupby_cols:
        # - subject_name
        - season
      percentiles:
        - 99.9
      auto_scale_or_custom_cell_size:
        auto_scale_or_custom: Customize
        grid_cell_size: 2000
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.add_season_labels.return }}

  - name: Time density colormap
    id: season_colormap
    task: apply_color_map
    skipif:
      conditions: 
      - any_is_empty_df
      - any_dependency_skipped
    partial:
      input_column_name: season
      output_column_name: season_colormap
      colormap: 
        - '#f57c00' 
        - '#255084' 
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.seasonal_home_range.return }}
  
  - name: Create map layers from seasons
    id: season_etd_map_layer
    task: create_polygon_layer
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      layer_style:
        fill_color_column: season_colormap
        opacity: 0.650000
      
      legend:
        label_column:  season
        color_column: season_colormap
      
      tooltip_columns:
        - percentile
    mapvalues:
      argnames: geodataframe
      argvalues: ${{ workflow.season_colormap.return }}

  - name: Zoom seasons by view state
    id: zoom_season_view
    task: create_view_state_from_gdf
    skipif:
      conditions:
        - any_is_empty_df
        - any_dependency_skipped
    partial:
      pitch: 0
      bearing: 0
    mapvalues:
      argnames: gdf
      argvalues: ${{ workflow.season_colormap.return }}

  - name: Combine map layers
    id: comb_season_map_layers
    task: combine_map_layers
    partial:
      static_layers: 
        - ${{ workflow.create_styled_landdx_layers.return }}
        - ${{ workflow.custom_text_layer.return }}
    mapvalues:
      argnames: grouped_layers
      argvalues: ${{ workflow.season_etd_map_layer.return }}

  # Zip up tasks to pass them on the same mapvalues
  - name: Zip seasons layers and zoom values
    id: seasons_view_zip
    task: zip_grouped_by_key
    partial:
      left:  ${{ workflow.comb_season_map_layers.return }}
      right: ${{ workflow.zoom_season_view.return }}

  - name: Draw season ecomap 
    id: seasonal_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Seasons
      static: false
      title: null
      max_zoom: 12
    
    mapvalues:
      argnames: 
         - geo_layers
         - view_state
      argvalues: ${{ workflow.seasons_view_zip.return }}

  - name: Perist season ecomap as text
    id: season_etd_ecomap_html_url
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}

    mapvalues:
      argnames: text 
      argvalues: ${{ workflow.seasonal_ecomap.return }}

  - name: Create map widgets for trajectories
    id: season_etd_widgets_single_view
    task: create_map_widget_single_view
    skipif:
      conditions: 
        - never
    partial:
      title: Seasonal Home Range
    map:
      argnames:
        - view 
        - data
      
      argvalues: ${{ workflow.season_etd_ecomap_html_url.return }}

  - name: Merge ecomap widgets 
    id: season_grouped_map_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.season_etd_widgets_single_view.return }}

  # 7. METRIC SUMMARY WIDGETS
  # calculate total MCP area per group
  - name: Calculate total mcp area
    id: total_mcp_area
    task: dataframe_column_sum
    partial:
      column_name: area_km2
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.calculate_mcp.return }}

  - name: Round off mcp area to 2 decimal places
    id: round_mcp_area
    task: round_off_values
    partial:
      dp: 2
    mapvalues:
      argnames: value
      argvalues: ${{ workflow.total_mcp_area.return }}

  # calculate total grid area per group
  - name: Calculate total grid area
    id: total_grid_area
    task: dataframe_column_sum
    partial:
      column_name: area_sqkm
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.generate_etd.return }}

  - name: Round off grid area to 2 decimal places
    id: round_grid_area
    task: round_off_values
    partial:
      dp: 2
    mapvalues:
      argnames: value
      argvalues: ${{ workflow.total_grid_area.return }}

  - name: Create single value widgets for total MCP area per group
    id: total_mcp_sv_widgets
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Total MCP Area (Km2)
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.round_mcp_area.return }}

  - name: Merge per group total MCP area SV widgets
    id: total_mcp_grouped_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_mcp_sv_widgets.return }}
  
  - name: Create single value widgets for total grid area per group
    id: total_grid_sv_widgets
    task: create_single_value_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Total Grid Area(Km2)
      decimal_places: 1
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.round_grid_area.return }}

  - name: Merge per group total grid area SV widgets
    id: total_grid_grouped_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.total_grid_sv_widgets.return }}

  - name: Determine subject gender 
    id: subject_gender
    task: dataframe_column_first_unique_str
    partial:
      column_name: subject_sex
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  - name: Create Single Value Widgets for subject gender per group
    id: gender_widgets
    task: create_text_widget_single_view
    skipif:
      conditions:
        - never
    partial:
      title: Gender
    map:
      argnames:
        - view
        - data
      argvalues: ${{ workflow.subject_gender.return }}

  - name: Merge per group gender SV widgets
    id: gender_sv_widget
    task: merge_widget_views
    partial:
      widgets: ${{ workflow.gender_widgets.return }}

  - name: Get report duration 
    id: report_duration
    task: get_duration
    partial:
      time_range: ${{ workflow.time_range.return }}
      time_unit: months

  - name: Round off report duration to 2 decimal_places
    id: round_report_duration
    task: round_off_values
    partial:
      dp: 2
      value: ${{ workflow.report_duration.return }}

  - name: Get subject name
    id: get_subject_name
    task: dataframe_column_first_unique_str
    partial:
      column_name: subject_name
    mapvalues:
      argnames: df
      argvalues: ${{ workflow.assign_quarter_colors_traj.return }}

  # Retrieve unique subjects extracted from relocs
  - name: Unique subjects on relocs
    id: unique_subjects
    task: dataframe_column_nunique
    partial:
      df: ${{ workflow.rename_traj_cols.return }}
      column_name: subject_name

  # Create cover context and persist 
  - name: Create cover template context 
    id: create_cover_template_context
    task: build_mapbook_report_template
    partial:
      count: ${{ workflow.unique_subjects.return }}
      org_logo_path: ${{ workflow.download_logo_path.return }}
      report_period: ${{ workflow.time_range.return }}
      prepared_by: "Ecoscope"
      
  - name: Persist context to cover template
    id: persist_context_cover
    task: create_context_page
    partial:
      logo_width_cm: 4.50
      logo_height_cm: 1.93
      template_path: ${{ workflow.download_mapbook_cover_page.return }}
      output_directory: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      context: ${{ workflow.create_cover_template_context.return }}
      filename: null
  
  # convert  ecomaps html to png using playwright and persist
  # 1. speedmap
  - name: Convert speedmap html to png 
    id: convert_speedmap_html_to_png
    task: html_to_png
    partial:
      output_dir : ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 40000
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_speed_ecomap_urls.return }}
  
  # 2. day/night ecomap
  - name: Convert day/night html to png
    id: convert_day_night_html_to_png
    task: html_to_png
    partial:
      output_dir : ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 40000
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_day_night_ecomap_urls.return }}

  # 3. quarter movement ecomap
  - name: Convert quarter html to png
    id: convert_quarter_html_to_png
    task: html_to_png
    partial:
      output_dir : ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config: 
        wait_for_timeout: 40000
    mapvalues:
      argnames: html_path 
      argvalues: ${{ workflow.persist_quarter_ecomap_urls.return }}

  # 4. home range ecomap
  - name: Convert home range html to png
    id: convert_hr_html_to_png
    task: html_to_png
    partial:
      output_dir : ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 40000
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.persist_hr_ecomap_urls.return }}

  # 5. speed raster ecomap
  - name: Convert speed raster html to png
    id: convert_speed_raster_html_to_png
    task: html_to_png
    partial:
      output_dir : ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 40000
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.speed_raster_ecomap_urls.return }}

  # 6. seasonal home range ecomap
  - name: Convert seasonal home range html to png
    id: convert_seasonal_hr_html_to_png
    task: html_to_png
    partial:
      output_dir : ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      config:
        wait_for_timeout: 40000
    mapvalues:
      argnames: html_path
      argvalues: ${{ workflow.season_etd_ecomap_html_url.return }}

  # === Zip mapbook context inputs into a single grouped iterable ===
  - name: Zip grid and mcp
    id: zip_grid_mcp
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.round_grid_area.return }}
      right: ${{ workflow.round_mcp_area.return }}

  - name: Zip with quarter png
    id: zip_grid_mcp_quarter
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_grid_mcp.return }}
      right: ${{ workflow.convert_quarter_html_to_png.return }}

  - name: Zip with hr png
    id: zip_grid_mcp_quarter_hr
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_grid_mcp_quarter.return }}
      right: ${{ workflow.convert_hr_html_to_png.return }}

  - name: Zip with speed raster png
    id: zip_grid_mcp_speedraster
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_grid_mcp_quarter_hr.return }}
      right: ${{ workflow.convert_speed_raster_html_to_png.return }}

  - name: Zip with day/night png
    id: zip_grid_mcp_dn
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_grid_mcp_speedraster.return }}
      right: ${{ workflow.convert_day_night_html_to_png.return }}

  - name: Zip with speedmap png
    id: zip_grid_dn_speedmap
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_grid_mcp_dn.return }}
      right: ${{ workflow.convert_speedmap_html_to_png.return }}

  - name: Zip with seasonal hr png (final)
    id: zip_all_mapbook_context_inputs
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_grid_dn_speedmap.return }}
      right: ${{ workflow.convert_seasonal_hr_html_to_png.return }}

  - name: Zip with subject name
    id: zip_all_with_name
    task: zip_grouped_by_key
    partial:
      left: ${{ workflow.zip_all_mapbook_context_inputs.return }}
      right: ${{ workflow.get_subject_name.return }}

  - name: Flatten zipped mapbook context inputs
    id: flatten_mbook_context
    task: flatten_tuple
    mapvalues:
      argnames: nested
      argvalues: ${{ workflow.zip_all_with_name.return }}

  - name: Get split group names 
    id: get_grouper_names 
    task: get_split_group_names
    partial:
      split_data: 
        - ${{ workflow.split_trajectories_by_group.return }}

  - name: Zip grouper names with flattened context 
    id: zip_grouper_with_context
    task: zip_lists 
    partial: 
      left: ${{ workflow.get_grouper_names.return }}
      right: ${{ workflow.flatten_mbook_context.return }}
  
  - name: Flatten final report context 
    id: flatten_final_report_context 
    task: flatten_tuple
    mapvalues:
      argnames: nested
      argvalues: ${{ workflow.zip_grouper_with_context.return }}

  - name: Prepare mapbook context 
    id: prepare_mapbook_context 
    task: create_report_context_from_tuple
    mapvalues:
      argnames:
        - grouper_type
        - grouper_eq
        - grouper_value
        - grid_area 
        - mcp_area 
        - movement_tracks_ecomap
        - home_range_ecomap
        - speed_raster_ecomap
        - night_day_ecomap
        - speedmap
        - seasonal_homerange
        - subject_name
      argvalues: ${{ workflow.flatten_final_report_context.return }}

  - name: Create individual mapbook context
    id: individual_mapbook_context
    task: create_mapbook_context
    partial:
      template_path: ${{ workflow.download_sect_templates.return }}
      output_directory: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      time_period: ${{ workflow.time_range.return }}
      period: ${{ workflow.round_report_duration.return }} # months
      filename: null
      validate_images: true
      box_h_cm: 6.5
      box_w_cm: 11.11

    mapvalues:
      argnames: context
      argvalues: ${{ workflow.prepare_mapbook_context.return }}

  # func to merge all individual subject mapbook sections and cover page
  - name: Generate final mapbook report
    id: generate_mapbook_report
    task: merge_docx_files
    partial:
      cover_page_path: ${{ workflow.persist_context_cover.return }}
      output_directory: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      context_page_items: ${{ workflow.individual_mapbook_context.return }}
      filename: mapbook_report.docx

  - name: Mapbook dashboard
    id: mapbook_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.initialize_workflow_metadata.return }}
      widgets:
        - ${{ workflow.gender_sv_widget.return }} # gender str widget
        - ${{ workflow.total_mcp_grouped_sv_widget.return }} # total mcp area widget
        - ${{ workflow.total_grid_grouped_sv_widget.return }} # total grid area widget
        - ${{ workflow.merge_speedmap_widgets.return }} #speedmap widgets
        - ${{ workflow.merge_day_night_ecomap_widgets.return }} # day/night widgets
        - ${{ workflow.merge_quarter_ecomap_widgets.return }} #prev-current quarter movement widgets
        - ${{ workflow.merge_hr_ecomap_widgets.return }} # etd hr widgets
        - ${{ workflow.speedraster_ecomap_widgets.return }} # speedraster widgets
        - ${{ workflow.season_grouped_map_widget.return }} # seasons 

      time_range: ${{ workflow.time_range.return }}
      groupers: ${{ workflow.groupers.return }}
