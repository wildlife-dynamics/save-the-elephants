# AUTOGENERATED BY ECOSCOPE-WORKFLOWS; see fingerprint in README.md for details


# ruff: noqa: E402

# %% [markdown]
# # Aerial Survey Lines
# TODO: top level description

# %% [markdown]
# ## Imports

import os

from ecoscope_workflows_core.tasks.config import (
    set_workflow_details as set_workflow_details,
)
from ecoscope_workflows_core.tasks.filter import set_time_range as set_time_range
from ecoscope_workflows_core.tasks.groupby import set_groupers as set_groupers
from ecoscope_workflows_core.tasks.io import persist_text as persist_text
from ecoscope_workflows_core.tasks.results import (
    create_map_widget_single_view as create_map_widget_single_view,
)
from ecoscope_workflows_core.tasks.results import gather_dashboard as gather_dashboard
from ecoscope_workflows_core.tasks.skip import (
    any_dependency_skipped as any_dependency_skipped,
)
from ecoscope_workflows_core.tasks.skip import any_is_empty_df as any_is_empty_df
from ecoscope_workflows_ext_custom.tasks.io import load_df as load_df
from ecoscope_workflows_ext_ecoscope.tasks.io import persist_df as persist_df
from ecoscope_workflows_ext_ecoscope.tasks.results import (
    create_polyline_layer as create_polyline_layer,
)
from ecoscope_workflows_ext_ecoscope.tasks.results import draw_ecomap as draw_ecomap
from ecoscope_workflows_ext_ecoscope.tasks.results import set_base_maps as set_base_maps
from ecoscope_workflows_ext_ste.tasks import (
    generate_survey_lines as generate_survey_lines,
)
from ecoscope_workflows_ext_ste.tasks import get_file_path as get_file_path

# %% [markdown]
# ## Set workflow details

# %%
# parameters

workflow_details_params = dict(
    name=...,
    description=...,
    image_url=...,
)

# %%
# call the task


workflow_details = (
    set_workflow_details.set_task_instance_id("workflow_details")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(**workflow_details_params)
    .call()
)


# %% [markdown]
# ## Time range

# %%
# parameters

time_range_params = dict(
    since=...,
    until=...,
)

# %%
# call the task


time_range = (
    set_time_range.set_task_instance_id("time_range")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        time_format="%d %b %Y %H:%M:%S %Z",
        timezone={
            "label": "UTC",
            "tzCode": "UTC",
            "name": "UTC",
            "utc_offset": "+00:00",
        },
        **time_range_params,
    )
    .call()
)


# %% [markdown]
# ## Set groupers

# %%
# parameters

groupers_params = dict(
    groupers=...,
)

# %%
# call the task


groupers = (
    set_groupers.set_task_instance_id("groupers")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(**groupers_params)
    .call()
)


# %% [markdown]
# ## Configure base map layers

# %%
# parameters

configure_base_maps_params = dict(
    base_maps=...,
)

# %%
# call the task


configure_base_maps = (
    set_base_maps.set_task_instance_id("configure_base_maps")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(**configure_base_maps_params)
    .call()
)


# %% [markdown]
# ## Retrieve input from get shapefile

# %%
# parameters

retrieve_file_params_params = dict(
    input_method=...,
)

# %%
# call the task


retrieve_file_params = (
    get_file_path.set_task_instance_id("retrieve_file_params")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        output_path=os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
        **retrieve_file_params_params,
    )
    .call()
)


# %% [markdown]
# ## load gdf

# %%
# parameters

load_gdf_params = dict()

# %%
# call the task


load_gdf = (
    load_df.set_task_instance_id("load_gdf")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        file_path=retrieve_file_params,
        layer=None,
        deserialize_json=False,
        **load_gdf_params,
    )
    .call()
)


# %% [markdown]
# ## Draw Aerial Survey Lines

# %%
# parameters

draw_survey_lines_params = dict(
    direction=...,
    spacing=...,
)

# %%
# call the task


draw_survey_lines = (
    generate_survey_lines.set_task_instance_id("draw_survey_lines")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(gdf=load_gdf, **draw_survey_lines_params)
    .call()
)


# %% [markdown]
# ## Persist aerial survey as geopackage

# %%
# parameters

persist_aerial_gdf_params = dict()

# %%
# call the task


persist_aerial_gdf = (
    persist_df.set_task_instance_id("persist_aerial_gdf")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        filetype="gpkg",
        filename="aerial_survey",
        df=draw_survey_lines,
        root_path=os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
        **persist_aerial_gdf_params,
    )
    .call()
)


# %% [markdown]
# ## Persist aerial survey as geoparquet

# %%
# parameters

persist_aerial_gpq_params = dict()

# %%
# call the task


persist_aerial_gpq = (
    persist_df.set_task_instance_id("persist_aerial_gpq")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        filetype="geoparquet",
        filename="aerial_survey",
        df=draw_survey_lines,
        root_path=os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
        **persist_aerial_gpq_params,
    )
    .call()
)


# %% [markdown]
# ## Create Aerial Survey Lines

# %%
# parameters

aerial_survey_polylines_params = dict(
    zoom=...,
)

# %%
# call the task


aerial_survey_polylines = (
    create_polyline_layer.set_task_instance_id("aerial_survey_polylines")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        layer_style={
            "get_width": 1.5,
            "get_color": "#2f4f4f",
            "opacity": 0.85,
            "width_unit": "pixels",
        },
        legend={"labels": ["Aerial survey lines"], "colors": ["#2f4f4f"]},
        tooltip_columns=[],
        geodataframe=draw_survey_lines,
        **aerial_survey_polylines_params,
    )
    .call()
)


# %% [markdown]
# ## Draw Aerial Survey Lines Ecomap

# %%
# parameters

draw_aerial_survey_lines_ecomap_params = dict(
    widget_id=...,
)

# %%
# call the task


draw_aerial_survey_lines_ecomap = (
    draw_ecomap.set_task_instance_id("draw_aerial_survey_lines_ecomap")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        tile_layers=configure_base_maps,
        static=False,
        max_zoom=12,
        north_arrow_style={"placement": "top-left"},
        legend_style={"placement": "bottom-right", "title": "Aerial survey lines"},
        title=None,
        geo_layers=aerial_survey_polylines,
        view_state=None,
        **draw_aerial_survey_lines_ecomap_params,
    )
    .call()
)


# %% [markdown]
# ## Persist Ecomaps

# %%
# parameters

persist_ecomaps_params = dict(
    filename_suffix=...,
)

# %%
# call the task


persist_ecomaps = (
    persist_text.set_task_instance_id("persist_ecomaps")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        root_path=os.environ["ECOSCOPE_WORKFLOWS_RESULTS"],
        text=draw_aerial_survey_lines_ecomap,
        filename="aerial_survey.html",
        **persist_ecomaps_params,
    )
    .call()
)


# %% [markdown]
# ## Create Ecomap Widgets

# %%
# parameters

create_aerial_widgets_params = dict(
    view=...,
)

# %%
# call the task


create_aerial_widgets = (
    create_map_widget_single_view.set_task_instance_id("create_aerial_widgets")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        title="Aerial Survey Lines",
        data=persist_ecomaps,
        **create_aerial_widgets_params,
    )
    .call()
)


# %% [markdown]
# ## Create Dashboard with Patrol Map Widgets

# %%
# parameters

patrol_dashboard_params = dict(
    warning=...,
)

# %%
# call the task


patrol_dashboard = (
    gather_dashboard.set_task_instance_id("patrol_dashboard")
    .handle_errors()
    .with_tracing()
    .skipif(
        conditions=[
            any_is_empty_df,
            any_dependency_skipped,
        ],
        unpack_depth=1,
    )
    .partial(
        details=workflow_details,
        widgets=create_aerial_widgets,
        time_range=time_range,
        groupers=groupers,
        **patrol_dashboard_params,
    )
    .call()
)
