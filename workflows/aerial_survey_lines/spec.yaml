id: aerial_survey_lines

requirements:
  - name: ecoscope-workflows-core
    version: "0.19.0.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-ecoscope
    version: "0.19.0.*"
    channel: https://repo.prefix.dev/ecoscope-workflows/

  - name: ecoscope-workflows-ext-custom
    version: "0.0.7.*"
    channel: https://repo.prefix.dev/ecoscope-workflows-custom/

  - name: ecoscope-workflows-ext-ste
    version: "*"
    channel: file:///tmp/ecoscope-workflows-custom/release/artifacts/

task-instance-defaults:
  skipif:
    conditions:
      - any_is_empty_df
      - any_dependency_skipped

workflow:
  - name: Set workflow details
    id: workflow_details
    task: set_workflow_details

  # define workflow time range
  - name: Time range
    id: time_range
    task: set_time_range
    partial:
      time_format: "%d %b %Y %H:%M:%S %Z"
      timezone: 
        label: UTC 
        tzCode: UTC 
        name: UTC 
        utc_offset: "+00:00"

  - name: Set groupers
    id: groupers
    task: set_groupers

  - name: Configure base map layers
    id: configure_base_maps
    task: set_base_maps

  - name: Retrieve input from get shapefile 
    id: retrieve_file_params
    task: get_file_path
    partial: 
      output_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      
  - name: load gdf 
    id: load_gdf 
    task: load_df 
    partial:
      file_path: ${{ workflow.retrieve_file_params.return }}
      layer: null
      deserialize_json: false

  - name: Draw Aerial Survey Lines
    id: draw_survey_lines
    task: generate_survey_lines
    partial:
      gdf: ${{ workflow.load_gdf.return }}

  - name: Persist aerial survey as geopackage
    id: persist_aerial_gdf
    task: persist_df
    partial:
      filetype: "gpkg"
      filename: aerial_survey
      df: ${{ workflow.draw_survey_lines.return }}
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}

  - name: Persist aerial survey as geoparquet
    id: persist_aerial_gpq
    task: persist_df
    partial:
      filetype: "geoparquet"
      filename: aerial_survey
      df: ${{ workflow.draw_survey_lines.return }}
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}


  - name: Create Aerial Survey Lines
    id: aerial_survey_polylines
    task: create_polyline_layer
    partial:
      layer_style: 
        get_width: 1.5
        get_color: "#2f4f4f"
        opacity: 0.85
        width_unit: pixels
      legend:
        labels: 
          - Aerial survey lines 
        colors:
          - "#2f4f4f"
      tooltip_columns: []
      geodataframe: ${{ workflow.draw_survey_lines.return }}


  - name: Draw Aerial Survey Lines Ecomap
    id: draw_aerial_survey_lines_ecomap
    task: draw_ecomap
    partial:
      tile_layers: ${{ workflow.configure_base_maps.return }}
      static: false
      max_zoom: 12
      north_arrow_style:
        placement: top-left
      legend_style:
        placement: bottom-right
        title: Aerial survey lines
      title: null
      geo_layers: ${{ workflow.aerial_survey_polylines.return }}
      view_state: null

  - name: Persist Ecomaps
    id: persist_ecomaps
    task: persist_text
    partial:
      root_path: ${{ env.ECOSCOPE_WORKFLOWS_RESULTS }}
      text: ${{ workflow.draw_aerial_survey_lines_ecomap.return }}
      filename: aerial_survey.html
  
  - name: Create Ecomap Widgets
    id: create_aerial_widgets
    task : create_map_widget_single_view
    partial: 
      title: "Aerial Survey Lines"
      data: ${{ workflow.persist_ecomaps.return }}

  - name: Create Dashboard with Patrol Map Widgets 
    id: patrol_dashboard
    task: gather_dashboard
    partial:
      details: ${{ workflow.workflow_details.return }}
      widgets: ${{ workflow.create_aerial_widgets.return }}
      time_range: ${{ workflow.time_range.return }}
      groupers: ${{ workflow.groupers.return }}