name: Test Workflows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # get tags, so hatch-vcs dev version is correct

      - name: Install pixi
        run: curl -fsSL https://pixi.sh/install.sh | bash && echo "$HOME/.pixi/bin" >> $GITHUB_PATH

      - name: Build release
        run: pixi run --manifest-path pixi.toml build-release

      - name: Upload conda channel
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            /tmp/ecoscope-workflows-custom/release/artifacts/
            !/tmp/ecoscope-workflows-custom/release/artifacts/bld
            !/tmp/ecoscope-workflows-custom/release/artifacts/src_cache
          if-no-files-found: error
          compression-level: 0

  discover-workflows:
    runs-on: ubuntu-latest
    outputs:
      workflows: ${{ steps.find-workflows.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find workflow folders
        id: find-workflows
        run: |
          workflows=$(find workflows -maxdepth 1 -type d ! -path workflows | sed 's|workflows/||' | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "workflows=$workflows" >> $GITHUB_OUTPUT
          echo "Found workflows: $workflows"

  # recompile-workflows:
  #   needs: [build-release, discover-workflows]
  #   if: needs.discover-workflows.outputs.workflows != '[]'
  #   runs-on: ubuntu-latest
  #   strategy:
  #     matrix:
  #       workflow: ${{ fromJson(needs.discover-workflows.outputs.workflows) }}
  #     fail-fast: false
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4

  #     - name: Download conda channel
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: release-artifacts
  #         path: /tmp/ecoscope-workflows-custom/release/artifacts

  #     - name: Install Pixi
  #       run: curl -fsSL https://pixi.sh/install.sh | bash && echo "$HOME/.pixi/bin" >> $GITHUB_PATH

  #     - name: Recompile workflow
  #       run: |
  #         pixi run --manifest-path pixi.toml --locked -e compile bash -c "./dev/recompile.sh ${{ matrix.workflow }} --update"

  #     - name: Check for differences in generated files
  #       id: check-diff
  #       run: |
  #         WORKFLOW_DIR_NAME=$(echo "${{ matrix.workflow }}" | tr '_' '-')
  #         GENERATED_DIR="workflows/${{ matrix.workflow }}/ecoscope-workflows-${WORKFLOW_DIR_NAME}-workflow"
  #         EXCLUDE_PATTERNS=":(exclude)${GENERATED_DIR}/pixi.lock :(exclude)${GENERATED_DIR}/VERSION.yaml :(exclude)${GENERATED_DIR}/graph.png"

  #         echo "Checking for differences in ${GENERATED_DIR}"

  #         if [ ! -d "${GENERATED_DIR}" ]; then
  #           echo "::error::Generated directory ${GENERATED_DIR} does not exist!"
  #           exit 1
  #         fi

  #         # Exclude auto-generated files: pixi.lock (dependency resolution), VERSION.yaml (auto-versioned), graph.png (binary)
  #         if ! git diff --exit-code -- "${GENERATED_DIR}" ${EXCLUDE_PATTERNS}; then
  #           echo "diff_found=true" >> $GITHUB_OUTPUT
  #         else
  #           echo "diff_found=false" >> $GITHUB_OUTPUT
  #           echo "No differences found - generated files are up to date!"
  #         fi

  #     - name: Display diff and fail if changes exist
  #       if: steps.check-diff.outputs.diff_found == 'true'
  #       run: |
  #         WORKFLOW_DIR_NAME=$(echo "${{ matrix.workflow }}" | tr '_' '-')
  #         GENERATED_DIR="workflows/${{ matrix.workflow }}/ecoscope-workflows-${WORKFLOW_DIR_NAME}-workflow"
  #         EXCLUDE_PATTERNS=":(exclude)${GENERATED_DIR}/pixi.lock :(exclude)${GENERATED_DIR}/VERSION.yaml :(exclude)${GENERATED_DIR}/graph.png"

  #         echo "::error::Generated files differ from committed files in ${GENERATED_DIR}"
  #         echo "Full diff (excluding auto-generated files):"
  #         git diff -- "${GENERATED_DIR}" ${EXCLUDE_PATTERNS}
  #         echo ""
  #         echo "::error::Please run the compilation locally and commit the changes."
  #         exit 1

  test-workflows:
    needs: [build-release, discover-workflows]
    if: needs.discover-workflows.outputs.workflows != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        workflow: ${{ fromJson(needs.discover-workflows.outputs.workflows) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Download conda channel
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: /tmp/ecoscope-workflows-custom/release/artifacts

      - name: Log conda channel contents
        run: ls -lR /tmp/ecoscope-workflows-custom/release/artifacts

      - name: Install pixi
        run: curl -fsSL https://pixi.sh/install.sh | bash && echo "$HOME/.pixi/bin" >> $GITHUB_PATH

      - name: Install system dependencies for Playwright
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libnss3 \
            libnspr4 \
            libatk1.0-0 \
            libatk-bridge2.0-0 \
            libcups2 \
            libdrm2 \
            libdbus-1-3 \
            libxkbcommon0 \
            libxcomposite1 \
            libxdamage1 \
            libxfixes3 \
            libxrandr2 \
            libgbm1 \
            libpango-1.0-0 \
            libcairo2 \
            libasound2t64 \
            libatspi2.0-0

      - name: Get workflow directory name
        id: workflow-dir
        run: |
          WORKFLOW_DIR_NAME=$(echo "ecoscope-workflows-${{ matrix.workflow }}-workflow" | tr '_' '-')
          echo "dir_name=${WORKFLOW_DIR_NAME}" >> $GITHUB_OUTPUT
          echo "Workflow directory name: ${WORKFLOW_DIR_NAME}"

      - name: Get test cases
        id: test-cases
        run: |
          TEST_CASES_FILE="workflows/${{ matrix.workflow }}/test-cases.yaml"
          if [ ! -f "$TEST_CASES_FILE" ]; then
            echo "No test-cases.yaml found, using default"
            echo "cases=" >> $GITHUB_OUTPUT
          else
            # Extract all top-level keys from test-cases.yaml
            CASES=$(yq eval 'keys | join(" ")' "$TEST_CASES_FILE")
            echo "cases=${CASES}" >> $GITHUB_OUTPUT
            echo "Found test cases: ${CASES}"
          fi

      - name: Run CLI tests
        run: |
          MANIFEST_PATH="workflows/${{ matrix.workflow }}/${{ steps.workflow-dir.outputs.dir_name }}/pixi.toml"
          CASES="${{ steps.test-cases.outputs.cases }}"

          # Build pytest command with --case flags for each test case
          CASE_FLAGS=""
          if [ -n "$CASES" ]; then
            for case in $CASES; do
              CASE_FLAGS="$CASE_FLAGS --case $case"
            done
          fi

          echo "Running tests with cases: $CASE_FLAGS"

          pixi update --manifest-path $MANIFEST_PATH

          pixi run --manifest-path $MANIFEST_PATH --locked -e test playwright-install

          pixi run --manifest-path $MANIFEST_PATH --locked -e test \
            bash -c "python -m pytest -v tests/test_results.py -k 'cli and sequential and mock-io' $CASE_FLAGS"

      - name: Validate result.json
        run: |
          RESULTS_DIR="workflows/${{ matrix.workflow }}/ecoscope-workflows-${{ steps.workflow-dir.outputs.dir_name }}-workflow"

          # Find all result.json files in the test results directory
          RESULT_FILES=$(find $RESULTS_DIR -name "result.json" -type f 2>/dev/null || true)

          if [ -z "$RESULT_FILES" ]; then
            echo "::error::No result.json files found in $RESULTS_DIR"
            exit 1
          fi

          echo "Found result.json files:"
          echo "$RESULT_FILES"

          # Check each result.json for error field
          ERROR_FOUND=false
          while IFS= read -r result_file; do
            echo "Checking $result_file"
            ERROR_VALUE=$(jq -r '.error // "null"' "$result_file")

            if [ "$ERROR_VALUE" != "null" ]; then
              echo "::error::Error found in $result_file: $ERROR_VALUE"
              cat "$result_file"
              ERROR_FOUND=true
            else
              echo "âœ“ $result_file has no errors"
            fi
          done <<< "$RESULT_FILES"

          if [ "$ERROR_FOUND" = true ]; then
            exit 1
          fi

          echo "All result.json files are valid!"
