name: Test Workflows

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - 'workflows/**'

jobs:
  check-no-src-changes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for src changes
        run: |
          # Fail if src/ was also modified
          if git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -q "^src/"; then
            echo "::error::This PR modifies both workflows/ and src/"
            echo "::error::Please separate into two PRs:"
            echo "::error::  1. PR for src/ changes (publish packages first)"
            echo "::error::  2. PR for workflows/ changes (uses published packages)"
            exit 1
          fi
          echo "âœ“ No src changes detected - proceeding with workflow tests"

  discover-changed-workflows:
    needs: check-no-src-changes
    runs-on: ubuntu-latest
    outputs:
      workflows: ${{ steps.find-workflows.outputs.workflows }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed workflow folders
        id: find-workflows
        run: |
          # Get list of changed workflow directories
          workflows=$(
            git diff --name-only origin/${{ github.base_ref }}...HEAD | \
              grep "^workflows/" | \
              cut -d'/' -f2 | \
              sort -u | \
              jq -R -s -c 'split("\n") | map(select(length > 0))'
          )
          echo "workflows=$workflows" >> $GITHUB_OUTPUT
          echo "Found changed workflows: $workflows"

  discover-workflow-test-pairs:
    needs: discover-changed-workflows
    runs-on: ubuntu-latest
    outputs:
      pairs: ${{ steps.find-pairs.outputs.pairs }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find test cases for changed workflows only
        id: find-pairs
        run: |
          # Get changed workflows from previous job
          changed_workflows='${{ needs.discover-changed-workflows.outputs.workflows }}'

          # Generate JSON array like: [{"workflow":"mapbook_report","case":"all-grouper"},...]
          pairs=$(
            echo "$changed_workflows" | jq -r '.[]' | while read workflow; do
              test_cases_file="workflows/${workflow}/test-cases.yaml"
              if [ -f "$test_cases_file" ]; then
                yq eval 'keys | .[]' "$test_cases_file" | while read case; do
                  echo "{\"workflow\":\"$workflow\",\"case\":\"$case\"}"
                done
              fi
            done | jq -s -c '.'
          )
          echo "pairs=$pairs" >> $GITHUB_OUTPUT
          echo "Found workflow-test pairs for changed workflows: $pairs"

  test-workflows:
    needs: discover-workflow-test-pairs
    if: needs.discover-workflow-test-pairs.outputs.pairs != '[]'
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include: ${{ fromJson(needs.discover-workflow-test-pairs.outputs.pairs) }}
        os: [ubuntu-latest, macos-latest, windows-latest]
      fail-fast: false
    steps:
      - uses: actions/checkout@v4

      - name: Install pixi
        run: curl -fsSL https://pixi.sh/install.sh | bash && echo "$HOME/.pixi/bin" >> $GITHUB_PATH


      - name: Write GEE key to file
        shell: bash
        run: |
          echo "${{ secrets.EE_KEY_JSON }}" > gee-key.json

      - name: Run a workflow test case
        shell: bash
        env:
          # Add your GitHub secrets here
          # They will be available to the workflow
          ECOSCOPE_WORKFLOWS__CONNECTIONS__EARTHRANGER__STE__SERVER: ${{ secrets.STE_SERVER }}
          ECOSCOPE_WORKFLOWS__CONNECTIONS__EARTHRANGER__STE__PASSWORD: ${{ secrets.STE_PASSWORD }}
          ECOSCOPE_WORKFLOWS__CONNECTIONS__EARTHRANGER__STE__USERNAME: ${{ secrets.STE_USERNAME }}
          ECOSCOPE_WORKFLOWS__CONNECTIONS__EARTHENGINE__ECOSCOPE_POC__SERVICE_ACCOUNT: ${{ secrets.EE_SERVICE_ACCOUNT }}
          ecoscope_workflows__connections__earthengine__ecoscope_poc__private_key: ${{ github.workspace }}/gee-key.json
        #   # Add more secrets as needed
        run: |
          chmod +x dev/pytest-cli.sh || true
          ./dev/pytest-cli.sh ${{ matrix.workflow }} ${{ matrix.case }}
